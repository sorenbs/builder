<!doctype html>
<html lang="en" >
<head>
	<meta charset="utf-8">
	<title>Crafty Builder</title>
	<link rel="stylesheet" href="css/app.css" />
	<link rel="stylesheet" href="lib/bootstrap/css/bootstrap.css" />
	<link rel="stylesheet" href="lib/CodeMirror/lib/codemirror.css" />
	<link rel="stylesheet" href="lib/CodeMirror/theme/ambiance.css"></link>
	<link rel="stylesheet" href="lib/CodeMirror/lib/util/simple-hint.css" />
	<link rel="stylesheet" href="css/editor.css" />
</head>
<body>
	<!-- NAVIGATION -->
	<div class="navbar navbar-fixed-top" ng-controller="MenuCtrl">
		<div class="navbar-inner">
			<div class="container">
				<a class="brand" href="/">CraftyBuilder</a>
				<ul class="nav">
					<li class="menu_item"><a onclick="fork();">Fork</a> </li>
					<li class="menu_item pull-right"><a onclick="display('editor');">Code</a> </li>
					<li class="menu_item pull-right"><a onclick="display('game');">Game</a> </li>
				</ul>
			</div>
		</div>
	</div>
	<!-- NAVIGATION END -->
	<!-- CONTENT -->
	<div style="width:100%" id="codeContainer" class="codeContainer">
		<textarea id="Code"></textarea>
		<!-- scriptEvaluator is used to evaluate the content of the editor -->
		<script id="scriptEvaluator" type="text/javascript"></script>
	</div>
	<div style="position: fixed; top: 40px; left:0px; width: 100%; height: 100%;" id="gameContainer" class="gameContainer">
			<div style="display: block" id="cr-stage">
			</div>
		</div>
		
	<!-- CONTENT END -->

	<script src="lib/jquery/jquery-1.7.1.min.js"></script>
	<script src="lib/underscore/underscore.js"></script>
	<script src="lib/CodeMirror/lib/codemirror.js"></script>
	<script src="lib/CodeMirror/mode/javascript/javascript.js"></script>
	<script src="lib/CodeMirror/lib/util/simple-hint.js"></script>
	<script src="lib/CodeMirror/lib/util/javascript-hint.js"></script>
	<script src="lib/bootstrap/js/bootstrap.js"></script>
	<script src="lib/crafty/crafty.js"></script>

	<script type="text/javascript">
		var host = 'http://localhost:8080';

		CodeMirror.commands.autocomplete = function (cm) {
			CodeMirror.simpleHint(cm, CodeMirror.javascriptHint);
		};
		var codeArea = document.getElementById('Code');
		var codeMirrorInstance = CodeMirror.fromTextArea(codeArea,
			{
				mode: 'javascript',
				theme: 'ambiance',
				lineNumbers: true,
				readOnly: 'nocursor',
				lineWrapping: true
			});
		
		function evalScript(script) {
			try {
				var scriptTag = document.createElement('script');
				scriptTag.id = 'scriptEvaluator';
				scriptTag.type = 'text/javascript';
				scriptTag.appendChild(document.createTextNode("try { (function() {\n" + script + "})()} catch (er) {\n console.log(er);}"));

				document.getElementById('scriptEvaluator').parentNode.replaceChild(scriptTag, document.getElementById('scriptEvaluator'));
			} catch (ex) {
				throw ex;
			}
		}
		
		function getURLParameter(name) {
			return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
		}
		
		$.ajax({
			url: host + "/api/craft/" + getURLParameter('id') + "/code/" + getURLParameter('version'),
			success: function (data) {
				if (data.error) {
					console.log(data.error);
				} else {
					codeMirrorInstance.setValue(data.code);
					codeMirrorInstance.save();
					Crafty.stop(true);
					evalScript(codeArea.value);
				}
			},
			dataType: 'json'
		});
		
		function display(what) {
			if(what === 'editor') {
				$('#codeContainer').removeClass('hidden');
				$('#gameContainer').addClass('hidden');
				codeMirrorInstance.refresh();
			} else {
				$('#codeContainer').addClass('hidden');
				$('#gameContainer').removeClass('hidden');
			}
		}

		display('game');
		
		function fork() {
			var id = getURLParameter('id');
			var version = getURLParameter('version');
			$.ajax({
				type: 'POST',
				url: host + "/api/craft/" + id + "/fork/" + version,
				data: {},
				success: function (data) {
					if (data.error) {
						console.log("Problem forking: " + data.error);
					} else {
						window.location = 'file:///C:/cc/builder/app/index.html?id=' + data.id + '&version=0';
					}
				}
			});
		}

	</script>

</body>
</html>
